{% extends "base.html" %}

{% block content %}
<header class="dashboard-header">
    <div class="tab-container">
        <button id="live-tab" class="tab-button active" onclick="switchTab('live')">
            Live
        </button>
        <button id="presence-tab" class="tab-button" onclick="switchTab('presence')">
            Presence
        </button>
        <button id="graphs-tab" class="tab-button" onclick="switchTab('graphs')">
            Frequency
        </button>
        <button id="log-tab" class="tab-button" onclick="switchTab('log')">
            Log
        </button>
        <button id="review-tab" class="tab-button text-muted" onclick="switchTab('review')" disabled>
            <p class="line-through">AI Training</p>
        </button>
    </div>
</header>

<section id="live-content" class="tab-content active">
    <div id="presence-widget" class="presence-widget card">
        <div class="widget-header">
            <h4 class="px-3">Who is Home (within ~10mins)</h4>
            <span id="home-count" class="badge">0</span>
        </div>
        <div id="people-list" class="people-chips">
            <span class="text-muted">Loading...</span>
        </div>
    </div>
    <div id="system-summary" class="system-status-bar">
    </div>

    <div id="sensors-grid" class="sensors-grid">
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Connecting to control panel...</p>
        </div>
    </div>
</section>

<section id="presence-content" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h3>Device Management</h3>
            <button class="btn btn-small btn-primary" onclick="loadPresenceDevices()">Refresh</button>
        </div>
        <div class="table-responsive">
            <table class="device-table">
                <thead>
                    <tr>
                        <th width="50">Status</th>
                        <th>Device Name</th>
                        <th>Details (Vendor/IP)</th>
                        <th>Hostname / MAC</th>
                        <th>Last Seen</th>
                        <th width="100">Actions</th>
                    </tr>
                </thead>
                <tbody id="device-list-body">
                </tbody>
            </table>
        </div>
    </div>
</section>

<section id="graphs-content" class="tab-content">
    <div class="card chart-card">
        <div class="chart-header">
            <h3>Activity Frequency Analysis</h3>
            <div class="chart-filters">
                <div class="input-group">
                    <label>Range:</label>
                    <select id="timeRange" class="form-select">
                        <option value="6">Last 6 Hours</option>
                        <option value="12">Last 12 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="48">Last 2 Days</option>
                        <option value="168">Last Week</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Bin Size:</label>
                    <select id="intervalRange" class="form-select">
                        <option value="15">15 Minutes</option>
                        <option value="30" selected>30 Minutes</option>
                        <option value="60">1 Hour</option>
                        <option value="120">2 Hours</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="canvas-wrapper" style="position: relative; height: 400px; width: 100%;">
            <canvas id="frequencyChart"></canvas>
        </div>

        <div id="chartInfo" class="chart-footer">
            Select a range to view data.
        </div>
    </div>
</section>

<section id="log-content" class="tab-content">
    <div class="card">
        <div class="card-header">Recent Events</div>
        <div id="activity-list" class="activity-list">
            <div class="empty-state">Waiting for activity...</div>
        </div>
    </div>
</section>

<section id="review-content" class="tab-content">
    <div class="review-layout">
        <div class="card control-panel">
            <div class="card-header">
                <h3>Sequence AI</h3>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="windowSize">Window (sec)</label>
                    <input type="number" id="windowSize" value="60" min="30" max="300">
                </div>
                <div class="form-group">
                    <label for="gapThreshold">Gap (sec)</label>
                    <input type="number" id="gapThreshold" value="300" min="60" max="1800">
                </div>
            </div>

            <div class="button-group vertical">
                <button class="btn btn-primary full-width" onclick="processSequences(false)">
                    Rebuild All
                </button>
                <button class="btn btn-secondary full-width" onclick="processSequences(true)">
                    Incremental Update
                </button>
                <button class="btn btn-outline full-width" onclick="loadProcessorState()">
                    Refresh State
                </button>
            </div>

            <div class="stats-mini">
                <div class="stat-row">
                    <span>Total Sequences</span> <strong id="totalSequences">0</strong>
                </div>
                <div class="stat-row">
                    <span>Labeled</span> <strong id="labeledSequences" class="text-success">0</strong>
                </div>
                <div class="stat-row">
                    <span>Unlabeled</span> <strong id="unlabeledSequences" class="text-warning">0</strong>
                </div>
            </div>
        </div>

        <div class="card list-panel">
            <div id="sequenceList" class="sequence-list">
                <div class="empty-state">
                    <p style="text-align:center; padding: 40px; color: var(--color-text-muted);">
                        Waiting for data...
                    </p>
                </div>
            </div>

            <div id="pagination" class="pagination"
                style="display: none; justify-content: center; padding-top: 20px; gap: 10px;">
                <button class="btn btn-small btn-secondary" onclick="changePage(-1)">Previous</button>
                <span id="pageInfo" style="align-self:center; font-size: 0.9rem;">Page 1 of 1</span>
                <button class="btn btn-small btn-secondary" onclick="changePage(1)">Next</button>
            </div>
        </div>
    </div>
</section>

<div id="sequenceModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <h2>Sequence Details</h2>
            <button class="close-btn" onclick="closeSequenceModal()">&times;</button>
        </div>
        <div id="sequenceDetail" class="modal-body">
        </div>
    </div>
</div>
<div id="editDeviceModal" class="modal-overlay">
    <div class="modal-card small-modal">
        <div class="modal-header">
            <h2>Edit Device</h2>
            <button class="close-btn"
                onclick="document.getElementById('editDeviceModal').classList.remove('active')">&times;</button>
        </div>
        <div class="modal-body form-grid">
            <input type="hidden" id="edit-device-id">

            <div class="form-group">
                <label>Name</label>
                <input type="text" id="edit-device-name" placeholder="e.g. Jared's iPhone">
            </div>

            <div class="form-group">
                <label>Owner</label>
                <input type="text" id="edit-device-owner" placeholder="e.g. Jared">
            </div>

            <div class="form-group checkbox-group"
                style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                <input type="checkbox" id="edit-device-track" style="width: auto; transform: scale(1.2);">
                <label for="edit-device-track" style="margin:0; cursor: pointer;">
                    Track Presence?
                    <span style="display:block; font-size: 0.75rem; opacity: 0.6; font-weight: normal;">
                        If unchecked, this device won't mark the owner as "Home".
                    </span>
                </label>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="submitDeviceUpdate()">Save</button>
                <button class="btn btn-danger" onclick="deleteDevice()">Delete Device</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
