{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Hardware Configuration</h2>
        <a href="/" class="btn btn-sm btn-ghost">Back to Dashboard</a>
    </div>
</div>

<div class="layout-grid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ 'Edit Hardware' if edit_hardware else 'Add Hardware' }}</h3>
            {% if edit_hardware %}
                <a href="{{ url_for('hardwares.manage_hardwares') }}" class="btn btn-sm btn-ghost">Cancel</a>
            {% endif %}
        </div>

        <form method="POST" action="{{ url_for('hardwares.edit_hardware', hardware_id=edit_hardware.id) if edit_hardware else url_for('hardwares.manage_hardwares') }}">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" name="name" class="form-input" placeholder="e.g. Kitchen Light" required value="{{ edit_hardware.name if edit_hardware else '' }}">
            </div>

            <div class="form-group">
                <label class="form-label">GPIO Pin (BCM)</label>
                <input type="number" name="pin" class="form-input" placeholder="e.g. 17" required 
                       value="{{ edit_hardware.configuration.get('pin') if edit_hardware and edit_hardware.configuration else '' }}">
            </div>

            <div class="form-group">
                <label class="form-label">Type</label>
                <select name="type" class="form-select">
                    {% for key, label in hardware_interfaces.items() %}
                        <option value="{{ key }}" 
                            {# Check if we are editing and this is the selected type #}
                            {% if edit_hardware and edit_hardware.driver_type == key %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 20px;">
                <input type="checkbox" name="enabled" id="chk_enabled" {{ 'checked' if (edit_hardware and edit_hardware.enabled) or not edit_hardware else '' }}>
                <label for="chk_enabled" class="form-label" style="margin: 0; cursor: pointer;">Enabled</label>
            </div>

            <button type="submit" class="btn btn-primary btn-block mt-4">
                {{ 'Save Changes' if edit_hardware else 'Create Hardware' }}
            </button>
        </form>
    </div>

    <div class="card">
        <div class="table-container">
            <table class="glass-table">
                <thead>
                    <tr>
                        <th width="40">ID</th>
                        <th>Name</th>
                        <th>Pin</th>
                        <th>Type</th>
                        <th>State</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hardware in hardwares %}
                    <tr style="{{ 'background: var(--bg-glass-hover);' if edit_hardware and edit_hardware.id == hardware.id else '' }}">
                        <td class="text-mono text-muted">#{{ hardware.id }}</td>
                        <td><strong>{{ hardware.name }}</strong></td>
                        <td class="text-mono">{{ hardware.configuration.get('pin', '-') }}</td>
                        <td>
                            {# Look up the readable name, default to the raw type if not found #}
                            {% set label = hardware_interfaces[hardware.driver_type] if hardware.driver_type in hardware_interfaces else hardware.driver_type %}
                            <span class="badge badge-gray">{{ label }}</span>
                        </td>
                        <td>
                            {% if hardware.enabled %}
                                <span class="text-success">Active</span>
                            {% else %}
                                <span class="text-muted">Disabled</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group flex-end" style="display: flex; gap: 8px;">
                                <a href="{{ url_for('hardwares.edit_hardware', hardware_id=hardware.id) }}" class="btn btn-sm">Edit</a>
                                <form method="POST" action="{{ url_for('hardwares.delete_hardware', hardware_id=hardware.id) }}" onsubmit="return confirm('Delete {{ hardware.name }}?');">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center text-muted" style="padding: 30px;">No hardware configured.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script type="module" src="{{ url_for('static', filename='js/core.js') }}"></script>
{% endblock %}